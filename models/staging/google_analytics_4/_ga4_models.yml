
version: 2         

models:
  - name: stg_ga4__events_
    description: This dbt model processes and transforms Google Analytics 4 (GA4) event data to generate a comprehensive, session-level view of user interactions on a website or app. It extracts and calculates relevant dimensions, attributes, and metrics related to users, events, devices, geolocation, items, ecommerce, user lifetime value, privacy information, app information, and traffic sources. Additionally, it generates a session key to uniquely identify each user session, and extracts the page path from the page location parameter. The model is materialized as a view and can be used for detailed analysis of user behavior, session-level performance, and various other analytics purposes.
    tests:
      - duplicate_rows
    columns: 
      - name: event_date
        description: Date of the event.
        tests: 
          - null_1_pct
          - recency_2_days
      - name: event_name
        description: Name of the event.
        tests: 
          - null_1_pct
      - name: user_id
        description: Unique identifier for the user.
      - name: user_pseudo_id
        description: Pseudonymous identifier for the user.
      - name: stream_id
        description: Unique identifier for the data stream.
      - name: event_bundle_sequence_id
        description: Identifier for the sequence of event bundles.
      - name: device_vendor_id
        description: Identifier for the device vendor.
      - name: device_advertising_id
        description: Advertising identifier for the device.
      - name: items.item_id
        description: Unique identifier for the item.
      - name: items.location_id
        description: Identifier for the item location.
      - name: items.item_list_id
        description: Identifier for the item list.
      - name: items.promotion_id
        description: Identifier for the promotion associated with the item.
      - name: hostname
        description: Extracted hostname from the page_location parameter.
      - name: geo_region
        description: Geographical region associated with the event.
      - name: geo_city
        description: City associated with the event.
      - name: geo_country
        description: Country associated with the event.
      - name: geo_continent
        description: Continent associated with the event.
      - name: geo_sub_continent
        description: Sub-continent associated with the event.
      - name: geo_metro
        description: Metro area associated with the event.
      - name: device_category
        description: Category of the device.
      - name: device_mobile_brand_name
        description: Mobile brand name of the device.
      - name: device_mobile_model_name
        description: Mobile model name of the device.
      - name: device_mobile_marketing_name
        description: Mobile marketing name of the device.
      - name: device_mobile_os_hardware_model
        description: Mobile operating system hardware model of the device.
      - name: device_operating_system
        description: Operating system of the device.
      - name: device_operating_system_version
        description: Operating system version of the device.
      - name: device_language
        description: Language setting of the device.
      - name: device_is_limited_ad_tracking
        description: Flag indicating if the device has limited ad tracking enabled.
      - name: device_time_zone_offset_seconds
        description: Time zone offset in seconds for the device.
      - name: device_browser
        description: Browser used on the device.
      - name: device_browser_version
        description: Browser version used on the device.
      - name: items.item_name
        description: Name of the item.
      - name: items.item_brand
        description: Brand of the item.
      - name: items.item_variant
        description: Variant of the item.
      - name: items.item_category
        description: Primary category of the item.
      - name: items.item_category2
        description: Secondary category of the item.
      - name: items.item_category3
        description: Tertiary category of the item.
      - name: items.item_category4
        description: Fourth category level of the item.
      - name: items.item_category5
        description: Fifth category level of the item.
      - name: items.price_in_usd
        description: Price of the item in USD.
      - name: items.price
        description: Price of the item in its original currency.
      - name: items.quantity
        description: Quantity of the item.
      - name: items.item_revenue_in_usd
        description: Revenue generated by the item in USD.
      - name: items.item_revenue
        description: Revenue generated by the item in its original currency.
      - name: items.item_refund_in_usd
        description: Refund amount for the item in USD.
      - name: items.item_refund
        description: Refund amount for the item in its original currency.
      - name: items.coupon
        description: Coupon code associated with the item.
      - name: items.affiliation
        description: Affiliation associated with the item.
      - name: items.item_list_name
        description: Name of the item list.
      - name: items.item_list_index
        description: Index of the item in the item list.
      - name: items.promotion_name
        description: Name of the promotion associated with the item.
      - name: items.creative_name
        description: Name of the creative associated with the item.
      - name: items.creative_slot
        description: Slot of the creative associated with the item.
      - name: ecommerce_total_item_quantity
        description: Total item quantity in the ecommerce transaction.
      - name: ecommerce_purchase_revenue_in_usd
        description: Purchase revenue of the ecommerce transaction in USD.
      - name: ecommerce_purchase_revenue
        description: Purchase revenue of the ecommerce transaction in its original currency.
      - name: ecommerce_refund_value_in_usd
        description: Refund value of the ecommerce transaction in USD.
      - name: ecommerce_refund_value
        description: Refund value of the ecommerce transaction in its original currency.
      - name: ecommerce_shipping_value_in_usd
        description: Shipping value of the ecommerce transaction in USD.
      - name: ecommerce_shipping_value
        description: Shipping value of the ecommerce transaction in its original currency.
      - name: ecommerce_tax_value_in_usd
        description: Tax value of the ecommerce transaction in USD.
      - name: ecommerce_tax_value
        description: Tax value of the ecommerce transaction in its original currency.
      - name: ecommerce_unique_items
        description: Number of unique items in the ecommerce transaction.
      - name: ecommerce_transaction_id
        description: Identifier for the ecommerce transaction.
      - name: user_ltv_revenue
        description: User lifetime value revenue.
      - name: user_ltv_currency
        description: Currency of the user lifetime value revenue.
      - name: event_value_in_usd
        description: Event value in USD.
      - name: privacy_info_analytics_storage
        description: Analytics storage information for privacy purposes.
      - name: privacy_info_ads_storage
        description: Ads storage information for privacy purposes.
      - name: privacy_info_uses_transient_token
        description: Flag indicating if the event uses a transient token for privacy purposes.
      - name: app_info_id
        description: Identifier for the app.
      - name: app_info_version
        description: Version of the app.
      - name: app_info_install_store
        description: App store where the app was installed.
      - name: app_info_firebase_app_id
        description: Firebase app identifier.
      - name: app_info_install_source
        description: Source of the app installation.
      - name: traffic_source_name
        description: Name of the traffic source.
      - name: traffic_source_medium
        description: Medium of the traffic source.
      - name: traffic_source_source
        description: Source of the traffic.
      - name: platform
        description: Platform of the event (e.g., web or app).
      - name: event_dimensions_hostname
        description: Hostname associated with the event dimensions.
      - name: exit_page
        description: Exit page of the session.
      - name: event_timestamp
        description: Timestamp of the event.
      - name: event_previous_timestamp
        description: Timestamp of the previous event.
      - name: event_server_timestamp_offset
        description: Server timestamp offset of the event.
      - name: user_first_touch_timestamp
      
  - name: stg_ga4__events_unioned
    description: This model combines data from multiple Google Analytics 4 (GA4) event tables and parses the 'event_date' column as a date. The model is parameterized to allow for multiple GA4 event tables to be combined using a for loop and union all statement.
    tests:
      - dbt_expectations.expect_table_row_count_to_equal_other_table:
          compare_model: source("ga_01","events")

  - name: stg_dim_ga4__sessions
    description: This model is responsible for processing raw Google Analytics 4 events data, enriching it with first-click attribution information, and organizing sessions by including the derived information such as session source, medium, campaign, content, landing page, and exit page. It also provides details on the device and geographic information associated with each session. The model is materialized as a table, ensuring optimal query performance when analyzing user behavior, marketing campaign performance, and traffic sources.
    columns:
      - name: session_key
        description: Unique identifier for the user's session, derived from user_id and session_id.
      - name: is_first_session
        description: Boolean flag indicating if the session is the first session for the user.
      - name: session_start_key_page_location
        description: The full URL of the page where the session started.
      - name: session_source
        description: The source for the session, derived from UTM parameters or traffic source.
      - name: session_medium
        description: The medium for the session, derived from UTM parameters or traffic medium.
      - name: session_campaign
        description: The campaign name for the session, derived from UTM parameters or traffic campaign.
      - name: session_content
        description: The specific content for the session, derived from UTM parameters or traffic content.
      - name: session_ad_id
        description: The ad_id for the session, derived from UTM parameters.
      - name: session_ad_group_id
        description: The ad_group_id for the session, derived from UTM parameters.
      - name: session_placement_id
        description: The placement_id for the session, derived from UTM parameters.
      - name: traffic_source_name
        description: The traffic source name from the raw GA4 data.
      - name: traffic_source_medium
        description: The traffic source medium from the raw GA4 data.
      - name: traffic_source_source
        description: The traffic source from the raw GA4 data.
      - name: session_landing_page
        description: The landing page URL for the session without query parameters.
      - name: session_landing_page_path
        description: The landing page path for the session.
      - name: session_exit_page
        description: The exit page URL for the session without query parameters.
      - name: session_exit_page_path
        description: The exit page path for the session.
      - name: device_category
        description: The category of the user's device, such as desktop, tablet, or mobile.
      - name: device_mobile_brand_name
        description: The brand name of the user's mobile device.
      - name: device_mobile_model_name
        description: The model name of the user's mobile device.
      - name: device_mobile_marketing_name
        description: The marketing name of the user's mobile device.
      - name: device_mobile_os_hardware_model
        description: The hardware model of the user's mobile device operating system.
      - name: device_operating_system
        description: The operating system of the user's device.
      - name: device_operating_system_version
        description: The version of the user's device operating system.
      - name: device_advertising_id
        description: The advertising identifier associated with the user's device.
      - name: device_language
        description: The language setting of the user's device.
      - name: device_is_limited_ad_tracking
        description: Boolean flag indicating if the user's device has limited ad tracking enabled.
      - name: device_time_zone_offset_seconds
        description: The time zone offset of the user's device in seconds.
      - name: device_browser
        description: The browser used by the user during the session.
      - name: device_browser_version
        description: The version of the browser used by the user during the session.
      - name: geo_region
        description: The geographic region associated with the user's session.
      - name: geo_city
        description: The city associated with the user's session.
      - name: geo_country
        description: The country associated with the user's session.
      - name: geo_continent
        description: The continent associated with the user's session.
      - name: geo_sub_continent
        description: The sub-continent associated with the user's session.
      - name: geo_metro
        description: The metropolitan area associated with the user's session.
      - name: stream_id
        description: The unique stream identifier for the GA4 data stream.
      - name: platform
        description: The platform associated with the
      - name: platform
        description: The platform associated with the user's session, such as web, mobile app, or other platforms.
      - name: ad_name
        description: The ad_name associated with the session_ad_id.
      - name: ad_group_name
        description: The ad_group_name associated with the session_ad_group_id.
      - name: placement_name
        description: The placement_name associated with the session_placement_id.
    
  - name: stg_fct_ga4__sessions
    description: This model aggregates session-level data from the Google Analytics 4 (GA4) 'events' table, including the number of page views, engaged sessions, engaged time, purchases, and sessions. The model creates several common table expressions (CTEs) to extract and transform the data, including a CTE to identify new users ('new_users'), a CTE to identify session-level revenue ('session_revenue'), and a CTE to aggregate session-level data ('session_aggregates'). The resulting table is materialized as a table in the database and includes columns for new users, session-level revenue, start date, page views, engaged sessions, engaged time, purchases, and sessions. The model is partitioned by session start date.
    columns:
      - name: session_key
        description: Unique identifier for each session.
      - name: new_users
        description: Flag indicating whether the session is a new user session (1 = new user, 0 = returning user).
      - name: session_ecommerce_purchase_revenue
        description: The total revenue generated by the session, if any.
      - name: session_start_date
        description: The date on which the session started.
      - name: page_views
        description: The number of page views during the session.
      - name: engaged_sessions
        description: The number of sessions during which the user was engaged (i.e., actively interacting with the page).
      - name: engaged_time_msec
        description: The total amount of time the user spent engaged across all engaged sessions, in milliseconds.
      - name: purchases
        description: The number of purchases made during the session.
      - name: sessions
        description: The total number of sessions.

